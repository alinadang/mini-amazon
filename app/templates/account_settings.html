{% extends "base.html" %}
{% block content %}
<h1>Account Settings</h1>

<div class="d-flex align-items-center gap-3 mb-3">
  <a href="{{ url_for('users.user_purchases_page') }}"
     class="btn btn-info">
    View Purchase History
  </a>

  <a href="{{ url_for('social.my_reviews') }}"
     class="btn btn-secondary btn-sm text-white px-4 py-2 mx-4">
    My Reviews
  </a>

  <a href="{{ url_for('social.review_summary') }}"
     class="btn btn-secondary text-white">
    Summary
  </a>
</div>


<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'danger' if category == 'error' else category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if purchase_summary %}
<div class="mb-4">
  <h3>Spending Overview</h3>
  <div class="row">
    <div class="col-md-3 mb-3">
      <div class="card text-center bg-light">
        <div class="card-body">
          <div class="text-muted small">Total spent</div>
          <div class="h4 mb-0">
            ${{ '%.2f'|format(purchase_summary.total_spent) }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-center bg-light">
        <div class="card-body">
          <div class="text-muted small">Total orders</div>
          <div class="h4 mb-0">{{ purchase_summary.total_orders }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-center bg-light">
        <div class="card-body">
          <div class="text-muted small">Items purchased</div>
          <div class="h4 mb-0">{{ purchase_summary.total_items }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-center bg-light">
        <div class="card-body">
          <div class="text-muted small">Pending orders</div>
          <div class="h4 mb-0">{{ purchase_summary.pending_orders }}</div>
        </div>
      </div>
    </div>
  </div>

  {% if status_counts %}
  <div class="mt-2">
    <span class="text-muted small me-2">Order status breakdown:</span>
    {% for status, count in status_counts.items() %}
      <span class="badge bg-secondary me-1">
        {{ status|capitalize }}: {{ count }}
      </span>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endif %}

<div class="row">
  <!-- Profile -->
  <div class="col-md-4">
    <h3>Profile</h3>
    <form method="POST" action="{{ url_for('users.update_profile') }}">
      <div class="mb-3">
        <label>Email</label>
        <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
      </div>
      <div class="mb-3">
        <label>First name</label>
        <input type="text" name="firstname" class="form-control" value="{{ user.firstname }}" required>
      </div>
      <div class="mb-3">
        <label>Last name</label>
        <input type="text" name="lastname" class="form-control" value="{{ user.lastname }}" required>
      </div>
      <div class="mb-3">
        <label>Address</label>
        <textarea name="address" class="form-control">{{ user.address or '' }}</textarea>
      </div>
      <button type="submit" class="btn btn-primary">Save Profile</button>
    </form>
  </div>

  <!-- Password -->
  <div class="col-md-4">
    <h3>Password</h3>
    <form method="POST" action="{{ url_for('users.update_password') }}">
      <div class="mb-3">
        <label>Current password</label>
        <input type="password" name="current_password" class="form-control" required>
      </div>
      <div class="mb-3">
        <label>New password</label>
        <input type="password" name="new_password" class="form-control" required>
      </div>
      <div class="mb-3">
        <label>Confirm new password</label>
        <input type="password" name="confirm_password" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary">Change Password</button>
    </form>
  </div>

  <!-- Balance -->
  <div class="col-md-4">
    <h3>Balance</h3>
    <p>Current balance: ${{ '%.2f'|format(balance) }}</p>

    <form method="POST" action="{{ url_for('users.update_balance') }}">
      <div class="mb-3">
        <label>Amount</label>
        <input type="number" step="0.01" name="amount" class="form-control" required>
      </div>
      <div class="mb-3">
        <button type="submit" name="action" value="deposit" class="btn btn-success">Deposit</button>
        <button type="submit" name="action" value="withdraw" class="btn btn-warning">Withdraw</button>
      </div>
    </form>
  </div>
</div>

<div class="row mt-4">
  <!-- Spending by category -->
  <div class="col-md-6 mb-4">
    <h4>Spending by Category</h4>
    {% if spending_by_category and spending_by_category|length > 0 %}
      <table class="table table-sm table-striped">
        <thead>
          <tr>
            <th>Category</th>
            <th class="text-end">Total spent</th>
            <th class="text-end"># Orders</th>
          </tr>
        </thead>
        <tbody>
          {% for row in spending_by_category %}
          <tr>
            <td>{{ row.category }}</td>
            <td class="text-end">
              ${{ '%.2f'|format(row.total_spent) }}
            </td>
            <td class="text-end">{{ row.num_orders }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted small mb-0">No purchases yet.</p>
    {% endif %}
  </div>

  <!-- Recent spending timeline -->
  <div class="col-md-6 mb-4">
    <h4>Recent Spending (by day)</h4>
    {% if spending_timeline and spending_timeline|length > 0 %}
      <table class="table table-sm table-striped">
        <thead>
          <tr>
            <th>Date</th>
            <th class="text-end">Amount spent</th>
          </tr>
        </thead>
        <tbody>
          {% for day in spending_timeline %}
          <tr>
            <td>{{ day.day }}</td>
            <td class="text-end">
              ${{ '%.2f'|format(day.total_spent) }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted small mb-0">No recent spending data.</p>
    {% endif %}
  </div>
</div>

{% endblock %}
