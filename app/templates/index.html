{% extends "base.html" %}

{% block content %}

<br><br>

<h2>Products for sale:</h2>

<div style="margin-bottom:12px;">
  <a href="{{ url_for('products_api.product_browser') }}" class="btn btn-secondary">Browse Products</a>
  <a href="{{ url_for('sellers.sellers_list') }}" class="btn btn-secondary">Browse Sellers</a>
</div>

<table class="table table-hover table-bordered container">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Product ID</th>
      <th scope="col">Product Name</th>
      <th scope="col">Price</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for product in avail_products %}
      <tr>
        <th scope="row">{{ product.id }}</th>
        <td>{{ product.name }}</td>
        <td>{{ product.price }}</td>
        <td>
          {% if current_user.is_authenticated %}
            <form action="{{ url_for('wishlist.wishlist_add', product_id=product.id) }}"
                  method="POST" style="display:inline;">
              <input type="submit" value="Add to Wishlist"/>
            </form>
            <button type="button"
        class="btn btn-sm btn-success"
        style="margin-left:6px;"
        onclick="addToCart('{{ product.id }}')">
  Add to Cart
</button>

          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<br><br>
{% if current_user.is_authenticated %}
<h2>Your recent purchases:</h2>
<table class="table table-hover table-bordered container">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Purchase ID</th>
      <th scope="col">Product Name</th>
      <th scope="col">Price</th>
      <th scope="col">Date</th>
    </tr>
  </thead>
  <tbody>
    {% for purchase in purchase_history %}
      <tr>
        <th scope="row">{{ purchase.order_id }}</th>
        <td>{{ purchase.product_name }}</td>
        <td>{{ purchase.price }}</td>
        <td>{{ purchase.order_date }}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p><a href="{{ url_for('users.login') }}">Log in</a> to see your purchase history!</p>
{% endif %}

<script>
function addToCart(productId) {
  fetch('/api/cart/add', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ pid: productId, quantity: 1 })
  })
  .then(response => response.json())
  .then(data => {
    if(data.success) {
      alert("Item added to cart!");
    } else {
      alert("Failed to add to cart: " + (data.error || "Unknown error"));
    }
  })
  .catch(err => {
    alert("Failed to add to cart: " + err);
  });
}
</script>

{% endblock %}