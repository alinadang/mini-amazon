{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Product Browser</h2>

  <div style="margin-bottom:12px;">
    {% if current_user.is_authenticated %}
      <a class="btn btn-success btn-sm" href="{{ url_for('products_api.product_new') }}">+ Create Product</a>
    {% else %}
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('users.login') }}">Log in to create product</a>
    {% endif %}
    <a class="btn btn-link btn-sm" href="{{ url_for('index.index') }}" style="margin-left:8px;">Home</a>
  </div>

  <form id="browserForm" method="get" style="display:flex; gap:20px; align-items:flex-start;">
    <input type="hidden" name="page" value="1"/>

    <div style="width:260px; flex:0 0 260px;">
      <div style="border:1px solid #ddd; padding:14px; border-radius:8px; background:#fafafa;">
        <h5 style="font-weight:600;">Filters</h5>

        <div style="margin-top:12px;">
          <label style="font-weight:600;">Average rating</label>
          <div style="margin-top:6px;">
            <label style="display:block; margin-bottom:4px;">
              <input type="checkbox" name="ratings" value="5" {% if '5' in ratings_selected %}checked{% endif %}/>
              5★ — average exactly 5.0
            </label>
            <label style="display:block; margin-bottom:4px;">
              <input type="checkbox" name="ratings" value="4" {% if '4' in ratings_selected %}checked{% endif %}/>
              4★ — average ≥ 4.0 and &lt; 5.0
            </label>
            <label style="display:block; margin-bottom:4px;">
              <input type="checkbox" name="ratings" value="3" {% if '3' in ratings_selected %}checked{% endif %}/>
              3★ — average ≥ 3.0 and &lt; 4.0
            </label>
            <label style="display:block; margin-bottom:4px;">
              <input type="checkbox" name="ratings" value="2" {% if '2' in ratings_selected %}checked{% endif %}/>
              2★ — average ≥ 2.0 and &lt; 3.0
            </label>
            <label style="display:block; margin-bottom:4px;">
              <input type="checkbox" name="ratings" value="1" {% if '1' in ratings_selected %}checked{% endif %}/>
              1★ — average ≥ 1.0 and &lt; 2.0
            </label>
            <label style="display:block; margin-bottom:4px;">
              <input type="checkbox" name="ratings" value="no_reviews" {% if 'no_reviews' in ratings_selected %}checked{% endif %}/>
              No reviews
            </label>
          </div>
        </div>

        <div style="margin-top:16px;">
          <label style="font-weight:600;">Price Range</label>

          <div style="display:flex; flex-direction:column; gap:8px; margin-top:6px;">
            <input type="number"
                   name="min_price"
                   min="0"
                   step="0.01"
                   placeholder="Min"
                   value="{{ min_price }}"
                   style="width:100%; padding:6px; box-sizing:border-box;"/>

            <input type="number"
                   name="max_price"
                   min="0"
                   max="{{ ui_max_price }}"
                   step="0.01"
                   placeholder="Max (≤ {{ '%.2f'|format(ui_max_price) }})"
                   value="{{ max_price }}"
                   style="width:100%; padding:6px; box-sizing:border-box;"/>
          </div>
        </div>

        <div style="margin-top:18px;">
          <button type="submit" class="btn btn-primary btn-sm">Apply</button>
          <a class="btn btn-link btn-sm" href="{{ url_for('products_api.product_browser') }}">Reset</a>
        </div>
      </div>
    </div>

    <div style="flex:1;">
      <div style="margin-bottom:15px; display:flex; flex-wrap:wrap; gap:16px; align-items:center;">

        <div>
          Per page:
          <input name="per_page" type="number" value="{{ per_page if per_page else k }}"
                 min="1" max="2000" style="width:90px; margin-left:6px;"/>
        </div>

        <div>
          Sort:
          <select name="sort" style="margin-left:6px;">
            <option value="price" {% if sort=='price' %}selected{% endif %}>Price</option>
            <option value="name" {% if sort=='name' %}selected{% endif %}>Name</option>
            <option value="id" {% if sort=='id' %}selected{% endif %}>Newest</option>
            <option value="rating" {% if sort=='rating' %}selected{% endif %}>Average rating</option>
            <option value="sales" {% if sort=='sales' %}selected{% endif %}>Total Sales</option>
          </select>
        </div>

        <div>
          Direction:
          <select name="dir" style="margin-left:6px;">
            <option value="asc" {% if dir=='asc' %}selected{% endif %}>Ascending</option>
            <option value="desc" {% if dir=='desc' %}selected{% endif %}>Descending</option>
          </select>
        </div>

        <div>
          Category:
          <select name="category" style="margin-left:6px;">
            <option value="" {% if not category %}selected{% endif %}>(all)</option>
            {% for c in categories %}
              <option value="{{ c }}" {% if category==c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <div style="flex:1; min-width:260px;">
          Search:
          <input name="q"
                 type="text"
                 value="{{ q }}"
                 placeholder="Search by product name or description…"
                 style="width:100%; margin-left:6px; padding:6px; font-size:1rem;"/>
        </div>

        <div>
          <button type="submit" class="btn btn-primary btn-sm">Apply</button>
        </div>
      </div>

      {% if error %}
        <div class="alert alert-danger">Error: {{ error }}</div>
      {% endif %}

      {% if products %}
        <table class="table table-bordered table-striped">
          <thead class="thead-dark">
            <tr>
              <th style="width:50px;">ID</th>
              <th style="width:120px;"></th>
              <th>Product</th>
              <th>Summary</th>
              <th>Average rating</th>
              <th>Price</th>
              <th>Available</th>
              <th class="text-right" style="width:190px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for p in products %}
              <tr>
                <td>{{ p.id }}</td>
                <td>
                  {% set img_src = (p.image_url if p.image_url is not none and p.image_url|trim != '' else ('https://picsum.photos/seed/' ~ p.id ~ '/200/150')) %}
                  <img src="{{ img_src }}"
                       alt="{{ p.name }}"
                       style="max-width:100px; max-height:80px; object-fit:cover; border:1px solid #eee; padding:2px;"
                       loading="lazy"
                       onerror="this.onerror=null;this.src='https://via.placeholder.com/100x80?text=No+Image';" />
                </td>
                <td>
                  <a href="{{ url_for('products_api.product_detail', pid=p.id) }}">{{ p.name }}</a>
                  {% if p.category %}
                    <div style="font-size:0.9em; color:#666">Category: {{ p.category }}</div>
                  {% endif %}
                  <div style="font-size:0.85em; color:#444;">Sold: {{ p.total_sold }}</div>
                </td>
                <td>
                  {% if p.description %}
                    {{ p.description[:180] }}{% if p.description|length > 180 %}...{% endif %}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if p.avg_rating %}
                    {{ '%.1f'|format(p.avg_rating) }} ⭐
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>${{ '%.2f'|format(p.price or 0) }}</td>
                <td>{{ 'Yes' if p.available else 'No' }}</td>
                <td class="text-right">
                  {% if current_user.is_authenticated %}
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            onclick="wishlistAdd('{{ p.id }}')">
                      Add to wishlist
                    </button>
                  {% else %}
                    <a href="{{ url_for('users.login') }}" class="btn btn-sm btn-outline-secondary">
                      Log in to save
                    </a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <nav aria-label="Page navigation">
          <ul class="pagination">
            {% macro qs(page_num) -%}
              ?page={{ page_num }}&per_page={{ per_page }}&sort={{ sort }}&dir={{ dir }}&q={{ q }}&category={{ category }}
              {%- for r in ratings_selected %}&ratings={{ r }}{%- endfor %}
              {%- if min_price %}&min_price={{ min_price }}{%- endif %}
              {%- if max_price %}&max_price={{ max_price }}{%- endif %}
            {%- endmacro %}

            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('products_api.product_browser') }}{{ qs(1)|safe }}">« First</a>
            </li>

            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('products_api.product_browser') }}{{ qs(page-1)|safe }}">‹ Prev</a>
            </li>

            <li class="page-item disabled">
              <span class="page-link">Page {{ page }} of {{ total_pages }}</span>
            </li>

            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('products_api.product_browser') }}{{ qs(page+1)|safe }}">Next ›</a>
            </li>

            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('products_api.product_browser') }}{{ qs(total_pages)|safe }}">Last »</a>
            </li>
          </ul>
        </nav>
      {% else %}
        <p>No products found.</p>
      {% endif %}
    </div>
  </form>
</div>
<script>
function wishlistAdd(productId) {
  fetch(`{{ url_for('wishlist.wishlist_add', product_id=0) }}`
          .replace('0', productId.toString()), {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  }).then(resp => {
    if (resp.redirected) {
      window.location = resp.url;
    } else {
      window.location = "{{ url_for('wishlist.wishlist') }}";
    }
  }).catch(() => {
    window.location = "{{ url_for('wishlist.wishlist') }}";
  });
}
</script>

<script>
document.getElementById("browserForm").addEventListener("submit", function(e){
  const uiMax = parseFloat("{{ ui_max_price or 0 }}") || 0;
  const minEl = document.querySelector('input[name="min_price"]');
  const maxEl = document.querySelector('input[name="max_price"]');
  let min = minEl && minEl.value ? parseFloat(minEl.value) : null;
  let max = maxEl && maxEl.value ? parseFloat(maxEl.value) : null;

  if (min !== null && min < 0) { alert("Minimum price must be 0 or greater."); e.preventDefault(); return; }
  if (max !== null) {
    if (max < 0) { alert("Maximum price must be 0 or greater."); e.preventDefault(); return; }
    if (min !== null && max < min) { alert("Maximum price cannot be less than minimum."); e.preventDefault(); return; }
    if (uiMax && max > uiMax) { alert("Maximum price exceeds allowed maximum."); e.preventDefault(); return; }
  }
});

</script>
{% endblock %}