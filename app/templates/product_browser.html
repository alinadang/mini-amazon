{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Product Browser</h2>

  <div style="margin-bottom:12px;">
    <a class="btn btn-link btn-sm" href="{{ url_for('index.index') }}" style="margin-left:8px;">
      Home
    </a>
  </div>

  <form method="get" class="form-inline" style="margin-bottom:12px;">
    <input type="hidden" name="page" value="1"/>
    <label style="margin-right:8px">
      Per page
      <input name="per_page" type="number" value="{{ per_page if per_page is defined else k }}" min="1" max="2000" style="width:90px; margin-left:6px"/>
    </label>

    <label style="margin-left:12px; margin-right:8px">
      Sort
      <select name="sort" class="form-control form-control-sm" style="display:inline-block; width:160px; margin-left:6px">
        <option value="price" {% if sort=='price' %}selected{% endif %}>Price</option>
        <option value="name" {% if sort=='name' %}selected{% endif %}>Name</option>
        <option value="id" {% if sort=='id' %}selected{% endif %}>Newest</option>
      </select>
    </label>

    <label style="margin-left:12px; margin-right:8px">
      Direction
      <select name="dir" class="form-control form-control-sm" style="display:inline-block; width:120px; margin-left:6px">
        <option value="asc" {% if dir=='asc' %}selected{% endif %}>Ascending</option>
        <option value="desc" {% if dir=='desc' %}selected{% endif %}>Descending</option>
      </select>
    </label>

    <label style="margin-left:12px; margin-right:8px">
      Category
      <select name="category" class="form-control form-control-sm" style="display:inline-block; width:160px; margin-left:6px">
        <option value="" {% if not category %}selected{% endif %}>(all)</option>
        {% for c in categories %}
          <option value="{{ c }}" {% if category==c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </label>

    <label style="margin-left:12px; margin-right:8px">
      Search
      <input name="q" type="text" value="{{ q }}" placeholder="keyword in name" style="margin-left:6px"/>
    </label>

    <button type="submit" class="btn btn-primary btn-sm" style="margin-left:12px">Apply</button>
    <a href="{{ url_for('products_api.product_browser') }}" class="btn btn-link btn-sm" style="margin-left:8px">Reset</a>
  </form>

  {% if error %}
    <div class="alert alert-danger">Error: {{ error }}</div>
  {% endif %}

  {% if products and products|length > 0 %}
    <table class="table table-bordered table-striped">
      <thead class="thead-dark">
        <tr>
          <th style="width:120px;"></th>
          <th>Product</th>
          <th>Summary</th>
          <th>Price</th>
          <th>Available</th>
        </tr>
      </thead>
      <tbody>
        {% for p in products %}
          <tr>
            <td style="width:120px;">
              <img src="https://picsum.photos/seed/{{ p.id }}/200/150"
                alt="{{ p.name }}"
                style="max-width:100px; max-height:80px"
                loading="lazy"
                onerror="this.onerror=null;this.src='https://via.placeholder.com/100x80?text=No+Image';" />
            </td>
            <td><a href="{{ url_for('products_api.product_detail', pid=p.id) }}">{{ p.name }}</a>
                {% if p.category %}<div style="font-size:0.9em; color:#666">Category: {{ p.category }}</div>{% endif %}
            </td>
            <td>
              {% if p.description %}
                {{ p.description[:180] }}{% if p.description|length > 180 %}...{% endif %}
              {% else %}
                No description available.
              {% endif %}
            </td>
            <td>${{ '%.2f'|format(p.price or 0) }}</td>
            <td>{% if p.available %}Yes{% else %}No{% endif %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <nav aria-label="Page navigation">
      <ul class="pagination">
        {% set prev_page = page-1 %}
        {% set next_page = page+1 %}
        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('products_api.product_browser') }}?page=1&per_page={{ per_page }}&sort={{ sort }}&dir={{ dir }}&q={{ q }}">« First</a>
        </li>
        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('products_api.product_browser') }}?page={{ prev_page }}&per_page={{ per_page }}&sort={{ sort }}&dir={{ dir }}&q={{ q }}">‹ Prev</a>
        </li>

        <li class="page-item disabled"><span class="page-link">Page {{ page }} of {{ total_pages }}</span></li>

        <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('products_api.product_browser') }}?page={{ next_page }}&per_page={{ per_page }}&sort={{ sort }}&dir={{ dir }}&q={{ q }}">Next ›</a>
        </li>
        <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('products_api.product_browser') }}?page={{ total_pages }}&per_page={{ per_page }}&sort={{ sort }}&dir={{ dir }}&q={{ q }}">Last »</a>
        </li>
      </ul>
    </nav>
    
  {% else %}
    <p>No products found.</p>
  {% endif %}
</div>
{% endblock %}