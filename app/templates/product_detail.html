{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>{{ product.name }}</h2>
  <div style="font-size:0.9em; color:#666; margin-top:6px;">
    <span>Product ID: <strong>{{ product.id }}</strong></span>
    {% if creator %}
      &nbsp;·&nbsp;Created by: {{ creator.firstname }} {{ creator.lastname }}
    {% endif %}
    &nbsp;·&nbsp;<strong>Sold:</strong> {{ product_total_sold or 0 }}
  </div>
  

  <div style="display:flex; gap:18px; align-items:flex-start; margin-top:12px;">
    <div>
      <img src="{{ product.image_url or ('https://picsum.photos/seed/' ~ product.id ~ '/800/600') }}"
           alt="{{ product.name }}"
           style="max-width:300px; max-height:300px; border:1px solid #ddd; padding:6px"
           onerror="this.onerror=null;this.src='https://via.placeholder.com/300x300?text=No+Image';" />
    </div>
    <div style="flex:1">
      <p><strong>Price:</strong> ${{ '%.2f'|format(product.price or 0) }}</p>
      <p><strong>Available:</strong> {% if product.available %}Yes{% else %}No{% endif %}</p>
      {% if product.category %}
        <p><strong>Category:</strong> {{ product.category }}</p>
      {% endif %}

      {% if product.avg_rating is not none %}
        <p>
          <strong>Average Rating:</strong>
          ⭐ {{ '%.1f'|format(product.avg_rating) }}
          ({{ reviews|length }} review{{ reviews|length != 1 and 's' or '' }})
        </p>
      {% endif %}

      <hr/>
      <h4>Description</h4>
      <p>{{ product.description or "No description available." }}</p>
    </div>
  </div>

  <hr/>
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h4>Sellers</h4>

    <div>
      {% if current_user.is_authenticated and product.creator_id == current_user.id %}
        <a class="btn btn-sm btn-outline-primary" 
           href="{{ url_for('products_api.product_edit', pid=product.id) }}">
          Edit
        </a>
      {% endif %}

      {% if current_user.is_authenticated %}
        <form action="{{ url_for('products_api.product_sell', pid=product.id) }}" 
              method="post"
              style="display:inline-block; margin-left:8px;">
          <input type="hidden" name="product_id" value="{{ product.id }}"/>
          <input type="number" name="qty" value="1" min="1" style="width:80px"/>
          <input type="number" name="seller_price" step="0.01" placeholder="price" 
                 required style="width:110px"/>
          <button class="btn btn-sm btn-success" type="submit">List as Seller</button>
        </form>
      {% else %}
        <a class="btn btn-link btn-sm" href="{{ url_for('users.login') }}">Log in to sell</a>
      {% endif %}
    </div>
  </div>

  {% if sellers %}
  <table class="table table-sm mt-2">
    <thead>
      <tr>
        <th>Seller</th>
        <th>Qty</th>
        <th>Price</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for s in sellers %}
      <tr id="seller-row-{{ s.seller_id }}">
        <td>{{ s.firstname }} {{ s.lastname }}</td>
        <td class="seller-qty" data-seller="{{ s.seller_id }}">{{ s.quantity }}</td>
        <td>${{ '%.2f'|format(s.seller_price) }}</td>
        <td>
          <form method="post" style="display:flex; gap:8px; align-items:center;">
            <input type="hidden" name="pid" value="{{ product.id }}">
            <input type="hidden" name="seller_id" value="{{ s.seller_id }}">
            <input type="number" name="qty" value="1" min="1" max="{{ s.quantity }}"
                   style="width:80px" class="qty-input" data-seller="{{ s.seller_id }}"/>

            <button type="button"
                    class="btn btn-sm btn-primary js-add-to-cart"
                    data-pid="{{ product.id }}"
                    data-seller="{{ s.seller_id }}"
                    data-max="{{ s.quantity }}">
              Add to Cart
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No sellers currently for this product.</p>
  {% endif %}

  <hr/>
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h4>Reviews</h4>

    <div>
      {% if current_user.is_authenticated %}
        <!-- Write / edit my review -->
        <a class="btn btn-sm btn-outline-secondary"
           href="{{ url_for('products_api.product_add_review', pid=product.id) }}">
          Write / Edit My Review
        </a>

        <!-- Delete my review (if it exists, route will delete it; if not, it does nothing) -->
        <form method="post"
              action="{{ url_for('products_api.product_review_delete', pid=product.id) }}"
              style="display:inline-block; margin-left:6px;">
          <button type="submit" class="btn btn-sm btn-outline-danger">
            Delete My Review
          </button>
        </form>
      {% else %}
        <a class="btn btn-sm btn-outline-secondary"
           href="{{ url_for('users.login', next=request.path) }}">
          Log in to write a review
        </a>
      {% endif %}
    </div>
  </div>

  {% if reviews %}
    {% for r in reviews %}
      <div style="margin-bottom:12px">
        <strong>{{ r.firstname or 'Anonymous' }} {{ r.lastname or '' }}</strong>
        <span style="margin-left:8px">⭐ {{ r.rating }}</span>
        <div>{{ r.comment }}</div>
        <div style="font-size:0.8em; color:#777;">{{ r.date_reviewed }}</div>
      </div>
    {% endfor %}
  {% else %}
    <p>No reviews yet.</p>
  {% endif %}

  <p style="margin-top:20px;">
    <a href="{{ url_for('products_api.product_browser') }}">← Back to Browser</a>
  </p>
</div>


<div id="toast-container"
     style="position:fixed; right:20px; bottom:20px; z-index:1100;"></div>

<script>
function showToast(msg, isError) {
  const box = document.getElementById("toast-container");
  const t = document.createElement("div");
  t.textContent = msg;
  t.style.background = isError ? "#d9534f" : "#28a745";
  t.style.color = "white";
  t.style.padding = "10px 14px";
  t.style.borderRadius = "6px";
  t.style.marginTop = "8px";
  t.style.minWidth = "200px";
  t.style.opacity = "0";
  t.style.transition = "opacity .25s ease";
  box.appendChild(t);
  requestAnimationFrame(() => t.style.opacity = "1");
  setTimeout(() => { t.style.opacity = "0"; setTimeout(() => t.remove(), 300); }, 2500);
}

document.addEventListener("click", async function(e){
  const btn = e.target.closest(".js-add-to-cart");
  if (!btn) return;

  const pid = btn.dataset.pid;
  const seller = btn.dataset.seller;
  const maxQty = parseInt(btn.dataset.max);

  const qtyInput = document.querySelector(`input.qty-input[data-seller="${seller}"]`);
  let qty = parseInt(qtyInput.value);

  if (!maxQty || maxQty <= 0) {
    showToast("Out of stock", true);
    return;
  }
  if (!qty || qty <= 0) {
    showToast("Quantity must be at least 1", true);
    return;
  }
  if (qty > maxQty) {
    showToast(`Only ${maxQty} left in stock`, true);
    return;
  }

  try {
    const res = await fetch("{{ url_for('cart.add_to_cart') }}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify({ pid: pid, seller_id: seller, quantity: qty })
    });

    if (res.status === 401) {
      showToast("Login required", true);
      window.location = "{{ url_for('users.login') }}";
      return;
    }

    const data = await res.json();

    if (!data.success) {
      showToast(data.error || "Could not add to cart", true);
      return;
    }

    showToast("Added to cart", false);
    const newRemaining = data.remaining;
    const qtyCell = document.querySelector(`#seller-row-${seller} .seller-qty`);
    const btnRow = document.getElementById(`seller-row-${seller}`);

    if (qtyCell && newRemaining !== null && newRemaining !== undefined) {
      qtyCell.textContent = newRemaining;
      if (newRemaining <= 0) {
        showToast("Seller now out of stock", false);
        btn.disabled = true;
        qtyInput.value = 0;
        qtyInput.disabled = true;
      }
    }

  } catch (err) {
    console.error(err);
    showToast("Unexpected error adding to cart", true);
  }
});
</script>
{% endblock %}
