{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>{{ product.name }}</h2>
  <div style="font-size:0.9em; color:#666; margin-top:6px;">
    <span>Product ID: <strong>{{ product.id }}</strong></span>
    {% if creator %}
      &nbsp;·&nbsp;Created by: {{ creator.firstname }} {{ creator.lastname }}
    {% endif %}
  </div>

  <div style="display:flex; gap:18px; align-items:flex-start; margin-top:12px;">
    <div>
      <img src="{{ product.image_url or ('https://picsum.photos/seed/' ~ product.id ~ '/800/600') }}"
        alt="{{ product.name }}"
        style="max-width:300px; max-height:300px; border:1px solid #ddd; padding:6px"
        onerror="this.onerror=null;this.src='https://via.placeholder.com/300x300?text=No+Image';" />
    </div>
    <div style="flex:1">
      <p><strong>Price:</strong> ${{ '%.2f'|format(product.price or 0) }}</p>
      <p><strong>Available:</strong> {% if product.available %}Yes{% else %}No{% endif %}</p>
      {% if product.category %}
        <p><strong>Category:</strong> {{ product.category }}</p>
      {% endif %}
      <hr/>
      <h4>Description</h4>
      <p>{% if product.description %}{{ product.description }}{% else %}No description available.{% endif %}</p>
    </div>
  </div>

<hr/>
<div style="display:flex; justify-content:space-between; align-items:center;">
  <h4>Sellers</h4>
  <div>
    {% if current_user.is_authenticated and product.creator_id == current_user.id %}
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('products_api.product_edit', pid=product.id) }}">Edit</a>
    {% endif %}
    {% if current_user.is_authenticated %}
      <form action="{{ url_for('products_api.product_sell', pid=product.id) }}" method="post" style="display:inline-block; margin-left:8px;">
        <input type="hidden" name="product_id" value="{{ product.id }}"/>
        <input type="number" name="qty" value="1" min="1" style="width:80px; display:inline-block;"/>
        <input type="number" step="0.01" name="seller_price" placeholder="price" required style="width:110px; display:inline-block;"/>
        <button class="btn btn-sm btn-success" type="submit">List as Seller</button>
      </form>
    {% else %}
      <a class="btn btn-link btn-sm" href="{{ url_for('users.login') }}">Log in to sell</a>
    {% endif %}
  </div>
</div>

{% if sellers %}
<table class="table table-sm">
  <thead><tr><th>Seller</th><th>Qty</th><th>Price</th><th></th></tr></thead>
  <tbody>
    {% for s in sellers %}
    <tr>
      <td>{{ s.firstname }} {{ s.lastname }}</td>
      <td>{{ s.quantity }}</td>
      <td>${{ '%.2f'|format(s.seller_price) }}</td>
      <td>
        <form action="{{ url_for('cart.add_to_cart_form') }}" method="post" style="display:flex; gap:8px; align-items:center;">
          <input type="hidden" name="pid" value="{{ product.id }}">
          <input type="hidden" name="seller_id" value="{{ s.seller_id }}">
          <input type="number" name="qty" value="1" min="1" max="{{ s.quantity }}" style="width:80px"/>
          <button class="btn btn-sm btn-primary js-add-to-cart-ajax"
                  type="button"
                  data-pid="{{ product.id }}"
                  data-seller="{{ s.seller_id }}"
                  data-max="{{ s.quantity }}">
            Add to Cart
          </button>
          <button type="submit" style="display:none" aria-hidden="true"></button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
  <p>No sellers currently for this product.</p>
{% endif %}

  <hr/>
  <h4>Reviews</h4>
  {% if reviews %}
    {% for r in reviews %}
      <div style="margin-bottom:12px">
        <strong>{{ r.firstname or 'Anonymous' }} {{ r.lastname or '' }}</strong>
        <span style="margin-left:8px">⭐ {{ r.rating }}</span>
        <div style="font-size:0.95em; color:#333">{{ r.comment }}</div>
        <div style="font-size:0.8em; color:#777;">{{ r.date_reviewed }}</div>
      </div>
    {% endfor %}
  {% else %}
    <p>No reviews yet.</p>
  {% endif %}

  <p style="margin-top:20px;"><a href="{{ url_for('products_api.product_browser') }}">← Back to Browser</a></p>
</div>

<div id="toast-container" style="position:fixed; right:20px; bottom:20px; z-index:1100;"></div>

<script>
(function(){
  function showToast(message, isError) {
    const container = document.getElementById('toast-container');
    if (!container) return alert(message);
    const el = document.createElement('div');
    el.textContent = message;
    el.style.minWidth = '200px';
    el.style.marginTop = '8px';
    el.style.padding = '10px 14px';
    el.style.borderRadius = '6px';
    el.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
    el.style.fontSize = '14px';
    el.style.color = '#fff';
    el.style.background = isError ? '#d9534f' : '#28a745'; 
    el.style.opacity = '0';
    el.style.transition = 'opacity 160ms ease, transform 160ms ease';
    container.appendChild(el);
    requestAnimationFrame(function(){
      el.style.opacity = '1';
      el.style.transform = 'translateY(0)';
    });

    setTimeout(function(){
      el.style.opacity = '0';
      setTimeout(()=> el.remove(), 300);
    }, 3000);
  }

  function promptLogin(loginUrl) {
    if (confirm('You must be logged in to add to cart. Go to login page now?')) {
      window.location = loginUrl || '{{ url_for("users.login") }}';
    }
  }

  document.addEventListener('click', function(e){
    const btn = e.target.closest('.js-add-to-cart-ajax');
    if (!btn) return;
    e.preventDefault();

    const pid = btn.dataset.pid;
    const seller = btn.dataset.seller;
    let qty = 1;
    const form = btn.closest('form');
    if (form) {
      const qinput = form.querySelector('input[name="qty"], input[name="quantity"]');
      if (qinput) qty = qinput.value || 1;
    }
    qty = Math.max(1, parseInt(qty) || 1);

    fetch('{{ url_for("cart.add_to_cart") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ pid: pid, quantity: qty, seller_id: seller })
    }).then(async function(res){

      // Not logged in
      if (res.status === 401) {
        let json = {};
        try { json = await res.json(); } catch(_) {}
        promptLogin(json.login_url || '{{ url_for("users.login") }}');
        return;
      }
      let json = {};
      try { json = await res.json(); } catch(err) {
        showToast('Unexpected response from server', true);
        return;
      }
      if (json && json.success) {
        let msg = 'Added to cart';
        if (json.remaining !== undefined && json.remaining !== null) {
          msg += ' — ' + json.remaining + ' left';
        }
        showToast(msg, false);
      } else {
        showToast('Could not add to cart: ' + (json.error || 'unknown'), true);
      }
    }).catch(function(err){
      console.error('Add to cart failed', err);
      if (form) {
        const submit = form.querySelector('button[type="submit"]');
        if (submit) {
          submit.click();
          return;
        }
      }
      showToast('Add to cart failed', true);
    });
  });
})();
</script>
{% endblock %}